<html>
  <head>
    <meta charset="UTF-8" />
    <title>ml5 faceApi</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
  </head>
  <body>
    <h1>ml5 faceApi</h1>
    <p>
      Adapted from
      <a href="https://github.com/ml5js/ml5-examples/tree/release/p5js/FaceApi"
        >an ml5 example</a
      >
    </p>
    <script>
      let faceapi;
      let video;
      let detections;
      let img;

      // by default all options are set to true
      const detection_options = {
        withLandmarks: true,
        withDescriptors: false
      };

      function preload() {
        img = loadImage(
          "./select/Alfred Stieglitz.jpg"
        );
      }

      function setup() {
        createCanvas(img.width, img.height);
        background("violet");
        // image(img, 0, 0, width, height);
        // load up your video
        // video = createCapture(VIDEO);
        // video.size(width, height);
        // video.hide(); // Hide the video element, and just show the canvas
        faceapi = ml5.faceApi(detection_options, modelReady);
        textAlign(RIGHT);
      }

      function modelReady() {
        console.log("ready!");
        console.log(faceapi);
        faceapi.detect(img, gotResults);
      }

      function gotResults(err, result) {
        if (err) {
          console.log(err);
          return;
        }
        // console.log(result)
        detections = result;
        // image(img, 0, 0, width, height);

        if (detections) {
          console.log(detections);
          // drawBox(detections)
          drawLandmarks(detections);
        }
      }

      function drawBox(detections) {
        for (let i = 0; i < detections.length; i++) {
          const alignedRect = detections[i].alignedRect;
          const x = alignedRect._box._x;
          const y = alignedRect._box._y;
          const boxWidth = alignedRect._box._width;
          const boxHeight = alignedRect._box._height;

          noFill();
          stroke(161, 95, 251);
          strokeWeight(2);
          rect(x, y, boxWidth, boxHeight);
        }
      }

      function drawLandmarks(detections) {
        noFill();
        stroke("red");
        strokeWeight(35);

        for (let i = 0; i < detections.length; i++) {
          const mouth = detections[i].parts.mouth;
          const nose = detections[i].parts.nose;
          const leftEye = detections[i].parts.leftEye;
          const rightEye = detections[i].parts.rightEye;
          const rightEyeBrow = detections[i].parts.rightEyeBrow;
          const leftEyeBrow = detections[i].parts.leftEyeBrow;

          drawPart(mouth, true);
          drawPart(nose, false);
          drawPart(leftEye, true);
          drawPart(rightEye, true);
          drawPart(leftEyeBrow, false);
          drawPart(rightEyeBrow, false);
        }
      }

      function drawPart(feature, closed) {
        beginShape();
        for (let i = 0; i < feature.length; i++) {
          const x = feature[i]._x;
          const y = feature[i]._y;
          vertex(x, y);
        }

        if (closed === true) {
          endShape(CLOSE);
        } else {
          endShape();
        }
      }
    </script>
  </body>
</html>
