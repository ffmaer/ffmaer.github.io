<html>
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/addons/p5.dom.min.js"></script>
    <script src="./CCapture.all.min.js"></script>
  </head>
  <body>
    <script>
      const fr = 30; //framerate
      let btn;
      let centerX, centerY;
      let squareSize;
      let angle_step;
      let angle;
      let div_seconds;
      let chunks = [];
      let recorder;
      let stream;
      function setup() {
        createCanvas(300, 300);
        background("HONEYDEW");
        frameRate(fr);
        let options = { mimeType: "video/webm; codecs=vp9" };
        stream = document.querySelector("canvas").captureStream(fr);
        recorder = new MediaRecorder(stream, options);
        recorder.ondataavailable = e => {
          if (e.data.size > 0) {
            chunks.push(e.data);
            download();
          }
        };
        recorder.start();
        createDiv("Recording!");

        div_seconds = createDiv("0 seconds recorded!");
        btn = createButton("Save").mouseClicked(stop);
        angleMode(DEGREES);
        randomConfig();
      }

      function stop() {
        recorder.stop();
        btn.hide();
        noLoop();
      }

      function draw() {
        if (angle == 360) {
          randomConfig();
        }
        translate(centerX, centerY);
        rotate(angle);
        stroke(random(["AQUAMARINE", "MediumSpringGreen"]));
        noFill();
        rect(30, 30, squareSize, squareSize);
        angle += angle_step;
        div_seconds.html(`${floor(frameCount / fr)} seconds recorded`);
        if(frameCount > fr * 10 * 60){
          // after 10 minutes, stop recording
          stop();
        }
      }

      function randomConfig() {
        angle = 0;
        centerX = random(width);
        centerY = random(height);
        squareSize = random(20, 40);
        angle_step = random([1, 2, 3, 4, 5, 6, 8]);
      }

      function download() {
        // taken from https://developer.mozilla.org/en-US/docs/Web/API/MediaStream_Recording_API
        var blob = new Blob(chunks, {
          type: "video/webm"
        });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        a.href = url;
        a.download = "test.webm";
        a.click();
        window.URL.revokeObjectURL(url);
      }
    </script>
  </body>
</html>
