<html>
  <head>
    <meta charset="UTF-8" />
    <title>Green Mirror</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script
      src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"
      type="text/javascript"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>

    <style></style>
  </head>

  <script>
    let facemesh;
    let video;
    let predictions = [];
    let canvas_w = 800;
    let canvas_h = 600;
    let video_w = 640;
    let video_h = 480;
    let margin_left = 80;
    let margin_top = 60;

    function setup() {
      cnv = createCanvas(canvas_w, canvas_h);
      centerCanvas();
      video = createCapture(VIDEO);
      video.size(video_w, video_h);

      facemesh = ml5.facemesh(video, modelReady);

      // This sets up an event that fills the global variable "predictions"
      // with an array every time new predictions are made
      facemesh.on("predict", (results) => {
        predictions = results;
      });

      // Hide the video element, and just show the canvas
      video.hide();
      mic = new p5.AudioIn();
      mic.start();
      cnv.mousePressed(userStartAudio);
    }

    function modelReady() {
      console.log("Model ready!");
    }

    function drawMicLevel() {
      push();
      fill("black");
      text("click to start mic", 50, 30);
      micLevel = mic.getLevel();
      text(micLevel, width / 2, height / 2);
      noStroke();
      fill(0, 255, 0, map(micLevel, 0, 1, 255, 0));
      circle(width / 2, height / 2, map(mouseX, 0, width, 400, 800));
      pop();
    }

    function drawKeyboardEffects() {
      if (key == "1") {
        fill(random(["lime", "pink", "yellow"]));
        noStroke();
        circle(random(width), random(height), random(10, 20));
      } else if (key == "2") {
        strokeWeight(random(1, 5));
        stroke(random(["lime", "pink", "yellow"]));
        line(random(width), random(height), random(width), random(height));
      }
    }

    function draw() {
      drawBackground();

      image(video, margin_left, margin_top, video_w, video_h);
      // We can call both functions to draw all keypoints
      drawKeypoints();
      drawForeground();
      drawKeyboardEffects();
      drawMicLevel();
    }

    function drawForeground() {
      noStroke();
      circle(random(width), random(height), map(mouseY, 0, height, 0, 100));
    }

    function drawBackground() {
      background("lime");
      noStroke();
      rect(random(width), 0, map(mouseX, 0, width, 10, 100), height);
    }

    // A function to draw ellipses over the detected keypoints
    function drawKeypoints() {
      for (let i = 0; i < predictions.length; i += 1) {
        const keypoints = predictions[i].scaledMesh;

        // Draw facial keypoints.
        for (let j = 0; j < keypoints.length; j += 1) {
          const [x, y] = keypoints[j]; // 468 points
          push();
          translate(margin_left, margin_top);
          textAlign(CENTER, CENTER);

          if (key == 3) {
            strokeWeight(1);
            stroke(0, 255, 0, 32);
            noFill();
            rectMode(CENTER);
            square(x, y, random(100));
          } else if (key == 4) {
            if (j % 3 == 0) {
              text(random(["ðŸ’š", "ðŸŸ©"]), x, y);
            }
          } else {
            stroke("lime");
            point(x, y);
          }

          pop();
        }
      }
    }
    function centerCanvas() {
      var x = (windowWidth - width) / 2;
      var y = (windowHeight - height) / 2;
      cnv.position(x, y);
    }
    function windowResized() {
      centerCanvas();
    }
  </script>

  <body></body>
</html>
